<div class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto fade-in">
    <!-- Header -->
    <div class="header">


        <!-- Filtros de Fecha -->
        <div class="date-filters">
            <button [class.active]="dateFilter === 'today'" (click)="setDateFilter('today')">
                {{ 'REPORTS.DATE_FILTER.TODAY' | translate }}
            </button>
            <button [class.active]="dateFilter === 'week'" (click)="setDateFilter('week')">
                {{ 'REPORTS.DATE_FILTER.WEEK' | translate }}
            </button>
            <button [class.active]="dateFilter === 'month'" (click)="setDateFilter('month')">
                {{ 'REPORTS.DATE_FILTER.MONTH' | translate }}
            </button>
            <button [class.active]="dateFilter === 'year'" (click)="setDateFilter('year')">
                {{ 'REPORTS.DATE_FILTER.YEAR' | translate }}
            </button>
            <button [class.active]="dateFilter === 'custom'" (click)="setDateFilter('custom')">
                {{ 'REPORTS.DATE_FILTER.CUSTOM' | translate }}
            </button>
        </div>

        <!-- Date Picker para Custom -->
        <div *ngIf="dateFilter === 'custom'" class="custom-date-picker">
            <app-date-picker [(date)]="customStartDate" placeholder="Fecha inicio"></app-date-picker>
            <span class="text-emerald-600 font-medium">-</span>
            <app-date-picker [(date)]="customEndDate" placeholder="Fecha fin"></app-date-picker>
            <button (click)="applyCustomDateFilter()">
                {{ 'REPORTS.APPLY' | translate }}
            </button>
        </div>
    </div>

    <!-- Loading KPIs -->
    <div *ngIf="isLoadingKPIs" class="loading">
        <div class="spinner"></div>
        <p>{{ 'REPORTS.LOADING_KPIS' | translate }}</p>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid" *ngIf="!isLoadingKPIs && kpis">
        <div class="kpi-card green">
            <div class="kpi-icon"><i class="fas fa-money-bill-wave"></i></div>
            <div class="kpi-content">
                <div class="kpi-value">\${{ kpis.totalSales.toLocaleString('en-US', {minimumFractionDigits: 2}) }}</div>
                <div class="kpi-label">{{ 'REPORTS.TOTAL_SALES' | translate }}</div>
            </div>
        </div>

        <div class="kpi-card blue">
            <div class="kpi-icon"><i class="fas fa-box-open"></i></div>
            <div class="kpi-content">
                <div class="kpi-value">{{ kpis.completedOrders }}</div>
                <div class="kpi-label">{{ 'REPORTS.COMPLETED_ORDERS' | translate }}</div>
            </div>
        </div>

        <div class="kpi-card yellow">
            <div class="kpi-icon"><i class="fas fa-chart-line"></i></div>
            <div class="kpi-content">
                <div class="kpi-value">\${{ kpis.totalProfit.toLocaleString('en-US', {minimumFractionDigits: 2}) }}
                </div>
                <div class="kpi-label">{{ 'REPORTS.TOTAL_PROFIT' | translate }}</div>
            </div>
        </div>

        <div class="kpi-card red">
            <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="kpi-content">
                <div class="kpi-value">{{ kpis.lowStockCount }}</div>
                <div class="kpi-label">{{ 'REPORTS.CRITICAL_PRODUCTS' | translate }}</div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs">
        <button [class.active]="activeTab === 'sales'" (click)="changeTab('sales')">
            <i class="fas fa-chart-line"></i>
            {{ 'REPORTS.SALES_TAB' | translate }}
        </button>
        <button [class.active]="activeTab === 'products'" (click)="changeTab('products')">
            <i class="fas fa-box"></i>
            {{ 'REPORTS.PRODUCTS_TAB' | translate }}
        </button>
        <button [class.active]="activeTab === 'movements'" (click)="changeTab('movements')">
            <i class="fas fa-exchange-alt"></i>
            {{ 'REPORTS.MOVEMENTS_TAB' | translate }}
        </button>
    </div>

    <!-- Tab Content: Sales -->
    <div *ngIf="activeTab === 'sales'" class="tab-content">
        <div class="chart-container">
            <h2>{{ 'REPORTS.SALES_TREND' | translate }}</h2>
            <div class="chart-wrapper">
                <canvas #salesChart></canvas>
            </div>
        </div>

        <div class="sales-table">
            <h3>{{ 'REPORTS.DAILY_SALES' | translate }}</h3>
            <table>
                <thead>
                    <tr>
                        <th>{{ 'REPORTS.DATE' | translate }}</th>
                        <th>{{ 'REPORTS.ORDERS' | translate }}</th>
                        <th>{{ 'REPORTS.TOTAL_SALES' | translate }}</th>
                        <th>{{ 'REPORTS.PROFIT' | translate }}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let sale of salesData">
                        <td>{{ sale.date | date }}</td>
                        <td>{{ sale.orderCount }}</td>
                        <td>\${{ sale.totalSales.toLocaleString('en-US', {minimumFractionDigits: 2}) }}</td>
                        <td class="profit">\${{ sale.profit.toLocaleString('en-US', {minimumFractionDigits: 2}) }}</td>
                    </tr>
                </tbody>
            </table>

            <div *ngIf="salesData.length === 0 && !isLoadingSales" class="empty-state">
                <p>{{ 'REPORTS.NO_SALES_DATA' | translate }}</p>
            </div>
        </div>
    </div>

    <!-- Tab Content: Products -->
    <div *ngIf="activeTab === 'products'" class="tab-content">
        <div class="products-grid">
            <!-- Top Productos -->
            <div class="products-section">
                <h2>{{ 'REPORTS.TOP_PRODUCTS' | translate }}</h2>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>{{ 'REPORTS.PRODUCT' | translate }}</th>
                            <th>{{ 'REPORTS.SKU' | translate }}</th>
                            <th>{{ 'REPORTS.QUANTITY_SOLD' | translate }}</th>
                            <th>{{ 'REPORTS.REVENUE' | translate }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let product of topProducts; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td>{{ product.productName }}</td>
                            <td>{{ product.sku }}</td>
                            <td>{{ product.quantitySold }}</td>
                            <td>\${{ product.revenue.toLocaleString('en-US', {minimumFractionDigits: 2}) }}</td>
                        </tr>
                    </tbody>
                </table>

                <div *ngIf="topProducts.length === 0 && !isLoadingProducts" class="empty-state">
                    <p>{{ 'REPORTS.NO_TOP_PRODUCTS' | translate }}</p>
                </div>
            </div>

            <!-- Productos con Bajo Stock -->
            <div class="products-section">
                <h2>{{ 'REPORTS.LOW_STOCK_PRODUCTS' | translate }}</h2>
                <table>
                    <thead>
                        <tr>
                            <th>{{ 'REPORTS.PRODUCT' | translate }}</th>
                            <th>{{ 'REPORTS.SKU' | translate }}</th>
                            <th>{{ 'REPORTS.CURRENT_STOCK' | translate }}</th>
                            <th>{{ 'REPORTS.MIN_STOCK' | translate }}</th>
                            <th>{{ 'REPORTS.NEEDED' | translate }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let product of lowStockProducts" class="low-stock-row">
                            <td>{{ product.name }}</td>
                            <td>{{ product.sku }}</td>
                            <td class="stock-current">{{ product.current_stock }}</td>
                            <td>{{ product.min_stock }}</td>
                            <td class="stock-needed">{{ product.difference }}</td>
                        </tr>
                    </tbody>
                </table>

                <div *ngIf="lowStockProducts.length === 0 && !isLoadingLowStock" class="empty-state success">
                    <i class="fas fa-check-circle"></i>
                    <p>{{ 'REPORTS.NO_LOW_STOCK' | translate }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content: Movements -->
    <div *ngIf="activeTab === 'movements'" class="tab-content">
        <div class="products-section">
            <h2>{{ 'REPORTS.MOVEMENTS_HISTORY' | translate }}</h2>

            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th>{{ 'REPORTS.DATE' | translate }}</th>
                            <th>{{ 'REPORTS.PRODUCT' | translate }}</th>
                            <th>{{ 'INVENTORY.TYPE' | translate }}</th>
                            <th>{{ 'INVENTORY.QUANTITY' | translate }}</th>
                            <th>{{ 'INVENTORY.USER' | translate }}</th>
                            <th>{{ 'INVENTORY.REASON' | translate }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of movementsData">
                            <td>
                                <div class="flex flex-col">
                                    <span class="font-medium">{{ item.created_at | date:'mediumDate' }}</span>
                                    <span class="text-xs text-gray-400">{{ item.created_at | date:'shortTime' }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="flex flex-col">
                                    <span class="font-medium">{{ item.product?.name }}</span>
                                    <span class="text-xs text-emerald-600 font-mono">{{ item.product?.sku }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="px-2 py-1 rounded-md text-xs font-bold uppercase tracking-wide border"
                                    [class.bg-emerald-50]="item.type === 'IN'"
                                    [class.text-emerald-700]="item.type === 'IN'"
                                    [class.border-emerald-200]="item.type === 'IN'"
                                    [class.bg-rose-50]="item.type === 'OUT'" [class.text-rose-700]="item.type === 'OUT'"
                                    [class.border-rose-200]="item.type === 'OUT'"
                                    [class.bg-blue-50]="item.type === 'ADJUSTMENT'"
                                    [class.text-blue-700]="item.type === 'ADJUSTMENT'"
                                    [class.border-blue-200]="item.type === 'ADJUSTMENT'">
                                    {{ item.type }}
                                </span>
                            </td>
                            <td class="font-bold text-right" [class.text-emerald-600]="item.type === 'IN'"
                                [class.text-rose-600]="item.type === 'OUT'"
                                [class.text-blue-600]="item.type === 'ADJUSTMENT'">
                                {{ item.type === 'OUT' ? '-' : '+' }}{{ item.quantity }}
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-500">
                                        {{ item.user?.full_name?.charAt(0) || 'U' }}
                                    </div>
                                    <span class="text-sm truncate max-w-[100px]">{{ item.user?.full_name }}</span>
                                </div>
                            </td>
                            <td class="text-sm text-gray-500 max-w-[200px] truncate" title="{{ item.reason }}">
                                {{ item.reason || '-' }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div *ngIf="isLoadingMovements" class="loading-state py-12 flex justify-center">
                <div class="spinner border-emerald-500"></div>
            </div>

            <div *ngIf="movementsData.length === 0 && !isLoadingMovements" class="empty-state">
                <p>{{ 'REPORTS.NO_MOVEMENTS_DATA' | translate }}</p>
            </div>
        </div>
    </div>
</div>